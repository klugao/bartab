name: Keep Render Backend Alive

on:
  schedule:
    # Executa a cada hora (0 minutos de cada hora)
    - cron: '0 * * * *'
  # Permite execu√ß√£o manual do workflow
  workflow_dispatch:

jobs:
  ping:
    name: Ping Backend Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping backend com retry
        shell: bash
        run: |
          echo "üåê Tentando fazer ping no backend do Render..."
          echo "üìÖ $(date)"
          
          # Substitua pela URL do seu backend no Render
          BACKEND_URL="https://bartab-backend.onrender.com"
          
          # Primeira tentativa
          echo "üîÑ Primeira tentativa..."
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/result.txt ${BACKEND_URL}/api/health || echo "CURL_FAILED")
          echo "üìä Resposta: $RESPONSE"
          
          # Verifica se o curl falhou completamente
          if [[ "$RESPONSE" == "CURL_FAILED" ]]; then
            echo "‚ùå Curl falhou completamente"
            exit 2
          fi
          
          # Extrai o status HTTP (√∫ltimos 3 caracteres)
          STATUS="${RESPONSE: -3}"
          echo "‚úÖ Status HTTP: $STATUS"
          
          # Se n√£o for 200, espera e tenta novamente (pode estar acordando)
          if [[ "$STATUS" != "200" ]]; then
            echo "‚è±Ô∏è  Backend pode estar acordando... Aguardando 30 segundos e tentando novamente..."
            sleep 30
            
            echo "üîÑ Segunda tentativa..."
            RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/result.txt ${BACKEND_URL}/api/health || echo "CURL_FAILED")
            echo "üìä Resposta: $RESPONSE"
            
            if [[ "$RESPONSE" == "CURL_FAILED" ]]; then
              echo "‚ùå Segunda tentativa falhou"
              exit 2
            fi
            
            STATUS="${RESPONSE: -3}"
            echo "‚úÖ Status HTTP ap√≥s retry: $STATUS"
          fi
          
          # Exibe o conte√∫do da resposta
          if [ -f /tmp/result.txt ]; then
            echo "üìÑ Conte√∫do da resposta:"
            cat /tmp/result.txt
          fi
          
          # Verifica se obtivemos sucesso
          if [[ "$STATUS" == "200" ]]; then
            echo "‚úÖ Backend est√° ativo e respondendo!"
            exit 0
          else
            echo "‚ö†Ô∏è  Backend respondeu com status $STATUS"
            exit 1
          fi

